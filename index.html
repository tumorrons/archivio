<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivio Personale</title>
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Gestisci il tuo archivio personale con QR code">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Archivio">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234F46E5' width='100' height='100'/><text y='75' font-size='70' fill='white' text-anchor='middle' x='50'>üì¶</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='70' text-anchor='middle' x='50'>üì¶</text></svg>">
    <link rel="manifest" id="manifest-placeholder">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        // Crea il manifest dinamicamente
        const manifestData = {
            "name": "Archivio Personale",
            "short_name": "Archivio",
            "description": "Gestisci il tuo archivio personale con QR code",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4F46E5",
            "orientation": "portrait",
            "icons": [
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%234F46E5' width='192' height='192' rx='40'/><text y='145' font-size='120' fill='white' text-anchor='middle' x='96'>üì¶</text></svg>",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%234F46E5' width='512' height='512' rx='100'/><text y='390' font-size='320' fill='white' text-anchor='middle' x='256'>üì¶</text></svg>",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ]
        };
        
        const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #4F46E5;
            font-size: 20px;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 0;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 10px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-tab .tab-icon {
            font-size: 20px;
        }

        .nav-tab.active {
            background: #4F46E5;
            color: white;
        }

        @media (min-width: 768px) {
            .nav-tabs {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .nav-tab {
                font-size: 13px;
                padding: 12px 10px;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4F46E5;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #4338CA;
        }

        .btn-secondary {
            background: #6B7280;
        }

        .btn-secondary:hover {
            background: #4B5563;
        }

        .btn-danger {
            background: #EF4444;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .photo-preview {
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .qr-preview {
            text-align: center;
            margin: 20px 0;
        }

        .qr-preview canvas {
            max-width: 100%;
            height: auto !important;
        }

        .box-list,
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .box-card,
        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .box-card:hover,
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .box-card h3,
        .item-card h3 {
            color: #4F46E5;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .box-card p,
        .item-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .item-photo {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-bar input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #4F46E5;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            background: #E0E7FF;
            color: #4F46E5;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            padding: 8px 16px;
            font-size: 14px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin: 15px 0;
        }

        #camera-preview {
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            display: none;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #F3F4F6;
            border: 2px dashed #D1D5DB;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #E5E7EB;
            border-color: #9CA3AF;
        }

        @media (max-width: 768px) {
            .box-list,
            .item-list {
                grid-template-columns: 1fr;
            }
        }

        .stats {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 24px;
            color: #4F46E5;
            margin-bottom: 3px;
        }

        .stat-card p {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Archivio Personale</h1>
    </div>

    <div class="container">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('home')">
                <span class="tab-icon">üè†¬†</span>
                <span>Home</span>
            </button>
            <button class="nav-tab" onclick="showTab('create-box')">
                <span class="tab-icon">üì¶</span>
                <span>Nuovo Box</span>
            </button>
            <button class="nav-tab" onclick="showTab('add-item')">
                <span class="tab-icon">‚ûï</span>
                <span>Aggiungi</span>
            </button>
            <button class="nav-tab" onclick="showTab('search')">
                <span class="tab-icon">üîç</span>
                <span>Cerca</span>
            </button>
            <button class="nav-tab" onclick="showTab('scan')">
                <span class="tab-icon">üì∏</span>
                <span>Scansiona</span>
            </button>
            <button class="nav-tab" onclick="showTab('backup')">
                <span class="tab-icon">üíæ</span>
                <span>Backup</span>
            </button>
        </div>

        <!-- HOME TAB -->
        <div id="home" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="box-count">0</h3>
                    <p>Box</p>
                </div>
                <div class="stat-card">
                    <h3 id="item-count">0</h3>
                    <p>Oggetti</p>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 15px; color: #333;">I tuoi Box</h2>
                <div id="box-list" class="box-list"></div>
            </div>
        </div>

        <!-- CREATE BOX TAB -->
        <div id="create-box" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Crea Nuovo Box</h2>
                
                <div class="form-group">
                    <label for="box-name">Nome del Box</label>
                    <input type="text" id="box-name" placeholder="es. Scatola Garage A1">
                </div>

                <div class="form-group">
                    <label for="box-description">Descrizione / Posizione</label>
                    <textarea id="box-description" placeholder="es. Scatola nel garage, scaffale superiore a sinistra"></textarea>
                </div>

                <div class="form-group">
                    <label>Codice QR</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="flex: 1;">
                            <input type="radio" name="qr-option" value="generate" checked onchange="toggleQROption()">
                            Genera nuovo QR code
                        </label>
                        <label style="flex: 1;">
                            <input type="radio" name="qr-option" value="existing" onchange="toggleQROption()">
                            Usa QR esistente
                        </label>
                    </div>
                    
                    <div id="existing-qr-section" style="display: none;">
                        <input type="text" id="existing-qr-code" placeholder="Codice del QR (es. BOX_001)" style="margin-bottom: 10px;">
                        <button class="btn" onclick="scanExistingQR()" type="button">üì∏ Scansiona QR Esistente</button>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">Puoi inserire manualmente il codice o scansionare il QR</p>
                    </div>
                </div>

                <button class="btn" onclick="createBox()">Crea Box</button>
            </div>
        </div>

        <!-- ADD ITEM TAB -->
        <div id="add-item" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Aggiungi Oggetto</h2>
                
                <div class="form-group">
                    <label for="item-name">Nome Oggetto</label>
                    <input type="text" id="item-name" placeholder="es. Trapano Bosch">
                </div>

                <div class="form-group">
                    <label for="item-description">Descrizione</label>
                    <textarea id="item-description" placeholder="Descrivi l'oggetto in dettaglio"></textarea>
                </div>

                <div class="form-group">
                    <label>Foto Oggetto</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="item-photo" accept="image/*" capture="environment" onchange="previewPhoto(this)">
                        <label for="item-photo" class="file-input-label">
                            üì∑ Scatta o Carica Foto
                        </label>
                    </div>
                    <img id="photo-preview" class="photo-preview" style="display: none;">
                    <p style="font-size: 12px; color: #666; margin-top: 8px;">
                        ‚ÑπÔ∏è Le foto vengono automaticamente compresse per risparmiare spazio
                    </p>
                </div>

                <div class="form-group">
                    <label for="item-box">Box di Destinazione</label>
                    <select id="item-box" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                        <option value="">Seleziona un box</option>
                    </select>
                    <button class="btn" onclick="showQRScanner()" style="margin-top: 10px;">üì∏ Oppure Scansiona QR Code</button>
                </div>

                <button class="btn btn-secondary" onclick="saveItem()">Salva Oggetto</button>
            </div>
        </div>

        <!-- SEARCH TAB -->
        <div id="search" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Cerca Oggetti</h2>
                
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Cerca per nome o descrizione..." oninput="searchItems()">
                </div>

                <div id="search-results" class="item-list"></div>
            </div>
        </div>

        <!-- SCAN TAB -->
        <div id="scan" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">Scansiona QR Code</h2>
                <p style="margin-bottom: 20px; color: #666;">Scansiona il QR code di un box per vedere tutti gli oggetti al suo interno</p>
                
                <div class="scanner-container">
                    <div id="qr-reader"></div>
                </div>

                <button class="btn btn-secondary" onclick="stopScanner()" style="margin-top: 20px;">Chiudi Scanner</button>
            </div>
        </div>

        <!-- BACKUP TAB -->
        <div id="backup" class="tab-content">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: #333;">üíæ Backup e Ripristino</h2>
                
                <div style="background: #EFF6FF; border-left: 4px solid #3B82F6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #1E40AF; font-size: 14px; margin: 0;">
                        <strong>Info:</strong> I tuoi dati sono salvati localmente sul dispositivo. Crea un backup per non perderli in caso di cambio dispositivo o cancellazione dati del browser.
                    </p>
                </div>

                <h3 style="color: #333; margin-bottom: 15px;">üóëÔ∏è Esporta Backup</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Scarica tutti i tuoi dati (box, oggetti e foto) in un file JSON</p>
                <button class="btn" onclick="exportBackup()">üì∑ Scarica Backup</button>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="color: #333; margin-bottom: 15px;">üì∑ Importa Backup</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Ripristina i dati da un file di backup precedente</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="backup-file" accept=".json" onchange="importBackup(this)">
                    <label for="backup-file" class="file-input-label">
                        üì§ Seleziona File Backup (.json)
                    </label>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="color: #333; margin-bottom: 15px;">üì• Condividi Dati</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Condividi il backup su altri dispositivi o servizi cloud</p>
                <button class="btn btn-secondary" onclick="shareBackup()">üóëÔ∏è Condividi Backup</button>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                <h3 style="color: #EF4444; margin-bottom: 15px;">‚ö†Ô∏è¬†√Ø¬∏¬è Cancella Tutti i Dati</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Elimina permanentemente tutti i box e oggetti. <strong>Questa azione non pu√É¬≤ essere annullata!</strong></p>
                <button class="btn btn-danger" onclick="deleteAllData()">üîÑ¬è Cancella Tutto</button>
            </div>

            <div class="card">
                <h3 style="color: #333; margin-bottom: 15px;">üìä Informazioni Archivio</h3>
                
                <!-- Avviso spazio quasi pieno (verr√† mostrato dinamicamente) -->
                <div id="storage-warning" style="display: none; background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #92400E; font-size: 14px; margin: 0;">
                        <strong>‚ö†Ô∏è Attenzione:</strong> Lo spazio di archiviazione √® quasi pieno. Considera di creare un backup e eliminare oggetti o foto non necessari.
                    </p>
                </div>
                
                <div id="storage-critical" style="display: none; background: #FEE2E2; border-left: 4px solid #EF4444; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #991B1B; font-size: 14px; margin: 0;">
                        <strong>üö® Critico:</strong> Lo spazio di archiviazione √® quasi esaurito! Crea urgentemente un backup ed elimina contenuti per liberare spazio.
                    </p>
                </div>
                
                <div style="background: #F9FAFB; padding: 15px; border-radius: 8px;">
                    <p style="margin-bottom: 8px; color: #666;"><strong>Box totali:</strong> <span id="backup-box-count">0</span></p>
                    <p style="margin-bottom: 8px; color: #666;"><strong>Oggetti totali:</strong> <span id="backup-item-count">0</span></p>
                    <p style="margin-bottom: 8px; color: #666;"><strong>Foto archiviate:</strong> <span id="backup-photo-count">0</span></p>
                    <p style="margin-bottom: 0; color: #666;"><strong>Dimensione stimata:</strong> <span id="backup-size">0 KB</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per visualizzare Box -->
    <div id="box-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-box-name"></h2>
                <button class="close-btn" onclick="closeModal('box-modal')">&times;</button>
            </div>
            <p id="modal-box-description" style="color: #666; margin-bottom: 20px;"></p>
            
            <button class="btn" onclick="showQRCode()" style="margin-bottom: 20px;">üì± Mostra QR Code per Stampa</button>
            
            <div class="qr-preview" id="modal-qr-container" style="display: none;"></div>
            
            <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Tipo QR Code da stampare:</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="qr-type" value="simple" checked>
                        <span style="color: #666; font-size: 14px;">üìÇ Semplice (ID) - Migliore per stampanti termiche</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="qr-type" value="url">
                        <span style="color: #666; font-size: 14px;">üåê¬ê URL Completo - Leggibile anche senza app</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="qr-type" value="both">
                        <span style="color: #666; font-size: 14px;">üì• Entrambi - Due QR code sull'etichetta</span>
                    </label>
                </div>
            </div>
            
            <button class="btn" onclick="shareQRCode()">üñ®Ô∏è¬è Condividi per Stampare</button>
            <button class="btn btn-secondary" onclick="downloadQRCode()">üíæ Scarica QR Code</button>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Oggetti in questo Box</h3>
            <div id="modal-items-list" class="item-list"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="editBox()">‚úèÔ∏è Modifica Box</button>
                <button class="btn btn-danger" onclick="deleteBox()">üîÑ¬è Elimina Box</button>
            </div>
        </div>
    </div>

    
    <!-- Modal per modificare Box -->
    <div id="edit-box-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Modifica Box</h2>
                <button class="close-btn" onclick="cancelBoxEdit()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="edit-box-name">Nome del Box</label>
                <input type="text" id="edit-box-name" placeholder="es. Scatola Garage A1">
            </div>

            <div class="form-group">
                <label for="edit-box-description">Descrizione / Posizione</label>
                <textarea id="edit-box-description" placeholder="es. Scatola nel garage, scaffale superiore a sinistra"></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="saveBoxEdit()">üíæ Salva Modifiche</button>
                <button class="btn btn-secondary" onclick="cancelBoxEdit()">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per visualizzare Oggetto -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-item-name"></h2>
                <button class="close-btn" onclick="closeModal('item-modal')">&times;</button>
            </div>
            
            <img id="modal-item-photo" class="photo-preview" style="display: none;">
            <p id="modal-item-description" style="color: #666; margin-bottom: 15px;"></p>
            <p id="modal-item-box" style="color: #4F46E5; font-weight: 600;"></p>

            <div class="action-buttons">
                <button class="btn btn-danger" onclick="deleteItem()">üîÑ¬è Elimina Oggetto</button>
            </div>
        </div>
    </div>

    <script>
        // Database locale usando localStorage
        let boxes = JSON.parse(localStorage.getItem('boxes')) || [];
        let items = JSON.parse(localStorage.getItem('items')) || [];
        let currentBox = null;
        let currentItem = null;
        let scanner = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            displayBoxes();
            updateBoxSelect();
            displayAllItems();
            
            // Registra Service Worker per PWA
            if ('serviceWorker' in navigator) {
                // Crea service worker inline
                const swCode = `
                    const CACHE_NAME = 'archivio-v1';
                    
                    self.addEventListener('install', (event) => {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(clients.claim());
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registrato'))
                    .catch(err => console.log('Service Worker non registrato:', err));
            }
            
            // Mostra banner di installazione
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });
            
            window.addEventListener('appinstalled', () => {
                hideInstallBanner();
                deferredPrompt = null;
            });
        });

        // Gestione tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'scan') {
                setTimeout(() => startScanner(), 300);
            } else {
                stopScanner();
            }

            if (tabName === 'search') {
                displayAllItems();
            }

            if (tabName === 'backup') {
                updateBackupInfo();
            }
        }

        // Toggle opzione QR
        function toggleQROption() {
            const option = document.querySelector('input[name="qr-option"]:checked').value;
            const existingQRSection = document.getElementById('existing-qr-section');
            
            if (option === 'existing') {
                existingQRSection.style.display = 'block';
            } else {
                existingQRSection.style.display = 'none';
                document.getElementById('existing-qr-code').value = '';
            }
        }

        // Scansiona QR esistente
        function scanExistingQR() {
            const modalScanner = document.createElement('div');
            modalScanner.id = 'modal-scanner-existing';
            modalScanner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;';
            
            const scannerContainer = document.createElement('div');
            scannerContainer.id = 'temp-qr-reader-existing';
            scannerContainer.style.cssText = 'width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Chiudi Scanner';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.cssText = 'margin-top: 20px; max-width: 300px;';
            
            modalScanner.appendChild(scannerContainer);
            modalScanner.appendChild(closeBtn);
            document.body.appendChild(modalScanner);

            let tempScannerInstance = null;
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };

            const tempScanner = new Html5Qrcode("temp-qr-reader-existing");
            tempScannerInstance = tempScanner;

            closeBtn.onclick = () => {
                if (tempScannerInstance) {
                    tempScannerInstance.stop().then(() => {
                        document.body.removeChild(modalScanner);
                    });
                } else {
                    document.body.removeChild(modalScanner);
                }
            };

            tempScanner.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    // Inserisci il codice letto nel campo
                    tempScanner.stop().then(() => {
                        document.body.removeChild(modalScanner);
                        document.getElementById('existing-qr-code').value = decodedText;
                        alert('üìä QR Code scansionato e inserito!');
                    }).catch(err => {
                        document.body.removeChild(modalScanner);
                        document.getElementById('existing-qr-code').value = decodedText;
                        alert('üìä QR Code scansionato e inserito!');
                    });
                },
                (errorMessage) => {
                    // Ignora errori di scansione continua
                }
            ).catch(err => {
                // Fallback: usa il metodo con scatto foto
                document.body.removeChild(modalScanner);
                
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.capture = 'environment';
                
                tempInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.id = 'fallback-qr-reader-existing';
                    fallbackDiv.style.display = 'none';
                    document.body.appendChild(fallbackDiv);

                    const html5QrCode = new Html5Qrcode("fallback-qr-reader-existing");
                    html5QrCode.scanFile(file, true)
                        .then(decodedText => {
                            document.getElementById('existing-qr-code').value = decodedText;
                            alert('üìä QR Code scansionato e inserito!');
                            document.body.removeChild(fallbackDiv);
                        })
                        .catch(err => {
                            alert('Impossibile leggere il QR code. Riprova o inserisci il codice manualmente.');
                            document.body.removeChild(fallbackDiv);
                        });
                };

                tempInput.click();
            });
        }

        // Crea nuovo box
        function createBox() {
            const name = document.getElementById('box-name').value.trim();
            const description = document.getElementById('box-description').value.trim();
            const qrOption = document.querySelector('input[name="qr-option"]:checked').value;

            if (!name) {
                alert('Inserisci un nome per il box');
                return;
            }

            let boxId;
            let isExisting = false;

            if (qrOption === 'existing') {
                const existingCode = document.getElementById('existing-qr-code').value.trim();
                if (!existingCode) {
                    alert('Inserisci o scansiona un codice QR esistente');
                    return;
                }
                
                // Verifica che il codice non sia gi√É¬† usato
                const existingBox = boxes.find(b => b.id === existingCode);
                if (existingBox) {
                    alert(`Questo QR code √É¬® gi√É¬† associato al box "${existingBox.name}". Usa un altro codice.`);
                    return;
                }
                
                boxId = existingCode;
                isExisting = true;
            } else {
                boxId = 'box_' + Date.now();
            }

            const box = {
                id: boxId,
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                isExisting: isExisting
            };

            boxes.push(box);
            localStorage.setItem('boxes', JSON.stringify(boxes));

            // Reset form
            document.getElementById('box-name').value = '';
            document.getElementById('box-description').value = '';
            document.getElementById('existing-qr-code').value = '';
            document.querySelector('input[name="qr-option"][value="generate"]').checked = true;
            toggleQROption();

            updateStats();
            displayBoxes();
            updateBoxSelect();

            // Mostra il modal con il QR code
            showBoxModal(box);
        }

        // Mostra modal del box con QR code
        function showBoxModal(box) {
            currentBox = box;
            document.getElementById('modal-box-name').textContent = box.name;
            document.getElementById('modal-box-description').textContent = box.description || 'Nessuna descrizione';

            // Nascondi il QR code inizialmente
            const qrContainer = document.getElementById('modal-qr-container');
            qrContainer.style.display = 'none';
            qrContainer.innerHTML = '';

            // Mostra oggetti nel box
            displayBoxItems(box.id);

            document.getElementById('box-modal').classList.add('active');
        }

        // Assicura che il QR code sia generato (helper per condivisione/download)
        async function ensureQRGenerated() {
            const qrContainer = document.getElementById('modal-qr-container');
            const existingCanvas = qrContainer.querySelector('canvas');
            
            // Se il QR esiste gi√†, non fare nulla
            if (existingCanvas) {
                return;
            }
            
            // Genera il QR temporaneamente (senza mostrarlo)
            if (currentBox.isExisting) {
                qrContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #F3F4F6; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #10B981; font-weight: 600; margin-bottom: 10px;">‚úì QR Code Esistente Associato</p>
                        <p style="color: #666; font-size: 14px;">Codice: ${currentBox.id}</p>
                    </div>
                    <div id="qrcode"></div>
                `;
            } else {
                qrContainer.innerHTML = '<div id="qrcode"></div>';
            }
            
            // Genera il QR code
            new QRCode(document.getElementById("qrcode"), {
                text: currentBox.id,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            // Aspetta un attimo che il QR sia renderizzato
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Mostra/Genera QR code quando richiesto
        function showQRCode() {
            const qrContainer = document.getElementById('modal-qr-container');
            
            // Se √® gi√† visibile, nascondilo
            if (qrContainer.style.display === 'block') {
                qrContainer.style.display = 'none';
                return;
            }

            // Mostra e genera il QR code
            qrContainer.style.display = 'block';
            
            if (currentBox.isExisting) {
                qrContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #F3F4F6; border-radius: 8px; margin-bottom: 15px;">
                        <p style="color: #10B981; font-weight: 600; margin-bottom: 10px;">‚úì QR Code Esistente Associato</p>
                        <p style="color: #666; font-size: 14px;">Codice: ${currentBox.id}</p>
                    </div>
                    <div id="qrcode"></div>
                `;
            } else {
                qrContainer.innerHTML = '<div id="qrcode"></div>';
            }
            
            // QR code semplice con solo l'ID per stampa termica
            new QRCode(document.getElementById("qrcode"), {
                text: currentBox.id,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M  // Livello medio, pi√π semplice da stampare
            });
        }

        // Condividi QR code per stampare
        async function shareQRCode() {
            const qrType = document.querySelector('input[name="qr-type"]:checked').value;
            
            let finalCanvas;
            
            if (qrType === 'simple') {
                finalCanvas = await createLabelWithSimpleQR();
            } else if (qrType === 'url') {
                finalCanvas = await createLabelWithURLQR();
            } else if (qrType === 'both') {
                finalCanvas = await createLabelWithBothQR();
            }

            // Converti in blob e condividi
            finalCanvas.toBlob(async (blob) => {
                const file = new File([blob], `etichetta_${currentBox.name.replace(/[^a-z0-9]/gi, '_')}.png`, { type: 'image/png' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: `Etichetta: ${currentBox.name}`,
                            text: currentBox.description || ''
                        });
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.log('Condivisione annullata', err);
                            downloadQRCodeWithInfo(finalCanvas);
                        }
                    }
                } else {
                    downloadQRCodeWithInfo(finalCanvas);
                }
            });
        }

        // Crea etichetta con QR semplice (solo ID)
        async function createLabelWithSimpleQR() {
            // Assicurati che il QR sia generato
            await ensureQRGenerated();
            
            const canvas = document.querySelector('#modal-qr-container canvas');
            if (!canvas) {
                alert('Errore nella generazione del QR code. Riprova.');
                return null;
            }
            
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            const qrSize = 200;
            const padding = 15; // Ridotto per ottimizzare lo spazio
            const textWidth = 320;
            finalCanvas.width = qrSize + textWidth + (padding * 3);
            finalCanvas.height = qrSize + (padding * 2);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            ctx.drawImage(canvas, padding, padding, qrSize, qrSize);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(padding, padding, qrSize, qrSize);
            
            drawBoxText(ctx, qrSize + (padding * 2), finalCanvas.height / 2, textWidth - 20);
            
            ctx.font = '12px Arial, sans-serif';
            ctx.fillStyle = '#D1D5DB';
            ctx.textAlign = 'right';
            ctx.fillText('üì¶ Archivio', finalCanvas.width - padding, finalCanvas.height - padding);
            
            return finalCanvas;
        }

        // Crea etichetta con QR URL completo
        async function createLabelWithURLQR() {
            // Genera QR code con URL
            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none';
            tempDiv.id = 'temp-qr-url';
            document.body.appendChild(tempDiv);
            
            const boxInfo = encodeURIComponent(JSON.stringify({
                id: currentBox.id,
                name: currentBox.name,
                description: currentBox.description
            }));
            const qrUrl = `${window.location.origin}${window.location.pathname}?box=${boxInfo}`;
            
            new QRCode(tempDiv, {
                text: qrUrl,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            // Aspetta che il QR sia generato
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const urlCanvas = tempDiv.querySelector('canvas');
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            const qrSize = 200;
            const padding = 15; // Ridotto per ottimizzare lo spazio
            const textWidth = 320;
            finalCanvas.width = qrSize + textWidth + (padding * 3);
            finalCanvas.height = qrSize + (padding * 2);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            ctx.drawImage(urlCanvas, padding, padding, qrSize, qrSize);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(padding, padding, qrSize, qrSize);
            
            drawBoxText(ctx, qrSize + (padding * 2), finalCanvas.height / 2, textWidth - 20);
            
            ctx.font = '12px Arial, sans-serif';
            ctx.fillStyle = '#D1D5DB';
            ctx.textAlign = 'right';
            ctx.fillText('üì¶ Archivio', finalCanvas.width - padding, finalCanvas.height - padding);
            
            document.body.removeChild(tempDiv);
            
            return finalCanvas;
        }

        // Crea etichetta con entrambi i QR code
        async function createLabelWithBothQR() {
            // Assicurati che il QR semplice sia generato
            await ensureQRGenerated();
            
            const simpleCanvas = document.querySelector('#modal-qr-container canvas');
            if (!simpleCanvas) {
                alert('Errore nella generazione del QR code. Riprova.');
                return null;
            }
            
            // Genera QR code con URL
            const tempDiv = document.createElement('div');
            tempDiv.style.display = 'none';
            tempDiv.id = 'temp-qr-url';
            document.body.appendChild(tempDiv);
            
            const boxInfo = encodeURIComponent(JSON.stringify({
                id: currentBox.id,
                name: currentBox.name,
                description: currentBox.description
            }));
            const qrUrl = `${window.location.origin}${window.location.pathname}?box=${boxInfo}`;
            
            new QRCode(tempDiv, {
                text: qrUrl,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const urlCanvas = tempDiv.querySelector('canvas');
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            // Dimensioni: QR grande a sinistra, testo al centro, QR piccolo in basso a destra
            const qrLargeSize = 200;
            const qrSmallSize = 75; // Ridotto per dare pi√π spazio al testo
            const padding = 15; // Ridotto per ottimizzare lo spazio
            const textWidth = 315; // Aumentato per testi lunghi
            finalCanvas.width = qrLargeSize + textWidth + (padding * 3);
            finalCanvas.height = qrLargeSize + (padding * 2);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // QR URL grande a sinistra
            ctx.drawImage(urlCanvas, padding, padding, qrLargeSize, qrLargeSize);
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.strokeRect(padding, padding, qrLargeSize, qrLargeSize);
            
            // Label sotto QR URL
            ctx.fillStyle = '#4F46E5';
            ctx.font = 'bold 12px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üåê¬ê QR Completo', padding + qrLargeSize/2, padding + qrLargeSize + 15);
            
            // Testo a destra
            const textStartX = qrLargeSize + (padding * 2);
            drawBoxText(ctx, textStartX, finalCanvas.height / 2, textWidth - qrSmallSize - 10);
            
            // QR semplice piccolo in basso a destra
            const qrSmallX = finalCanvas.width - qrSmallSize - padding;
            const qrSmallY = finalCanvas.height - qrSmallSize - padding;
            
            ctx.drawImage(simpleCanvas, qrSmallX, qrSmallY, qrSmallSize, qrSmallSize);
            ctx.strokeStyle = '#D1D5DB';
            ctx.lineWidth = 1;
            ctx.strokeRect(qrSmallX, qrSmallY, qrSmallSize, qrSmallSize);
            
            // Label per QR piccolo (sopra)
            ctx.fillStyle = '#9CA3AF';
            ctx.font = '9px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ID Backup', qrSmallX + qrSmallSize/2, qrSmallY - 4);
            
            document.body.removeChild(tempDiv);
            
            return finalCanvas;
        }

        // Funzione helper per disegnare il testo del box
        function drawBoxText(ctx, textStartX, textCenterY, maxWidth) {
            ctx.textAlign = 'left';
            
            let yPosition = textCenterY - 40;
            
            // Determina la dimensione del font in base alla lunghezza del nome
            let fontSize = 32;
            let boxName = currentBox.name;
            
            ctx.font = `bold ${fontSize}px Arial, sans-serif`;
            
            // Se il testo √® troppo lungo, riduci il font e vai a capo
            if (ctx.measureText(boxName).width > maxWidth) {
                // Prova con font pi√π piccolo
                fontSize = 24;
                ctx.font = `bold ${fontSize}px Arial, sans-serif`;
                
                // Se ancora troppo lungo, spezza su pi√π righe
                if (ctx.measureText(boxName).width > maxWidth) {
                    const words = boxName.split(' ');
                    let lines = [];
                    let currentLine = '';
                    
                    for (let word of words) {
                        const testLine = currentLine + (currentLine ? ' ' : '') + word;
                        if (ctx.measureText(testLine).width > maxWidth) {
                            if (currentLine) {
                                lines.push(currentLine);
                                currentLine = word;
                            } else {
                                // Parola singola troppo lunga - tagliala
                                while (ctx.measureText(word + '...').width > maxWidth && word.length > 0) {
                                    word = word.slice(0, -1);
                                }
                                lines.push(word + '...');
                                currentLine = '';
                            }
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    
                    // Disegna massimo 2 righe
                    ctx.fillStyle = '#1F2937';
                    if (lines.length > 2) {
                        lines = lines.slice(0, 2);
                        lines[1] = lines[1].substring(0, lines[1].length - 3) + '...';
                    }
                    
                    for (let i = 0; i < lines.length; i++) {
                        ctx.fillText(lines[i], textStartX, yPosition + (i * 28));
                    }
                    
                    yPosition += (lines.length - 1) * 28 + 10;
                } else {
                    // Disegna una riga con font ridotto
                    ctx.fillStyle = '#1F2937';
                    ctx.fillText(boxName, textStartX, yPosition);
                }
            } else {
                // Disegna normalmente con font grande
                ctx.fillStyle = '#1F2937';
                ctx.fillText(boxName, textStartX, yPosition);
            }
            
            // Linea separatrice
            ctx.strokeStyle = '#E5E7EB';

            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(textStartX, yPosition + 10);
            ctx.lineTo(textStartX + maxWidth, yPosition + 10);
            ctx.stroke();
            
            if (currentBox.description) {
                ctx.font = '18px Arial, sans-serif';
                ctx.fillStyle = '#6B7280';
                yPosition += 40;
                
                const words = currentBox.description.split(' ');
                let line = '';
                let lines = [];
                
                for (let word of words) {
                    const testLine = line + word + ' ';
                    if (ctx.measureText(testLine).width > maxWidth) {
                        if (line) lines.push(line.trim());
                        line = word + ' ';
                    } else {
                        line = testLine;
                    }
                }
                if (line) lines.push(line.trim());
                
                for (let i = 0; i < Math.min(lines.length, 3); i++) {
                    let displayLine = lines[i];
                    if (i === 2 && lines.length > 3) {
                        displayLine = displayLine.substring(0, displayLine.length - 3) + '...';
                    }
                    ctx.fillText(displayLine, textStartX, yPosition);
                    yPosition += 24;
                }
            }
        }

        // Scarica QR code con informazioni
        function downloadQRCodeWithInfo(canvas) {
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `etichetta_${currentBox.name.replace(/[^a-z0-9]/gi, '_')}.png`;
            a.click();
        }

        // Scarica QR code
        async function downloadQRCode() {
            const qrType = document.querySelector('input[name="qr-type"]:checked').value;
            
            let finalCanvas;
            
            if (qrType === 'simple') {
                finalCanvas = await createLabelWithSimpleQR();
            } else if (qrType === 'url') {
                finalCanvas = await createLabelWithURLQR();
            } else if (qrType === 'both') {
                finalCanvas = await createLabelWithBothQR();
            }

            const url = finalCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `etichetta_${currentBox.name.replace(/[^a-z0-9]/gi, '_')}.png`;
            a.click();
        }

        // Preview foto
        async function previewPhoto(input) {
            const preview = document.getElementById('photo-preview');
            if (input.files && input.files[0]) {
                try {
                    // Comprimi e mostra preview
                    const compressed = await compressImage(input.files[0]);
                    preview.src = compressed;
                    preview.style.display = 'block';
                } catch (error) {
                    console.error('Errore preview:', error);
                    // Fallback: mostra immagine originale
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
        }

        // Comprimi immagine per risparmiare spazio
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Calcola nuove dimensioni mantenendo le proporzioni
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        // Crea canvas per la compressione
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Converti in base64 compresso
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Salva oggetto
        async function saveItem() {
            const name = document.getElementById('item-name').value.trim();
            const description = document.getElementById('item-description').value.trim();
            const boxId = document.getElementById('item-box').value;
            const photoInput = document.getElementById('item-photo');

            if (!name) {
                alert('Inserisci un nome per l\'oggetto');
                return;
            }

            if (!boxId) {
                alert('Seleziona un box di destinazione');
                return;
            }

            let photoData = null;
            if (photoInput.files && photoInput.files[0]) {
                try {
                    // Comprimi l'immagine prima di salvarla
                    photoData = await compressImage(photoInput.files[0]);
                    
                    const item = {
                        id: 'item_' + Date.now(),
                        name: name,
                        description: description,
                        boxId: boxId,
                        photo: photoData,
                        createdAt: new Date().toISOString()
                    };

                    items.push(item);
                    
                    try {
                        localStorage.setItem('items', JSON.stringify(items));
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            // Rimuovi l'item appena aggiunto
                            items.pop();
                            alert('‚ö†Ô∏è Spazio di archiviazione esaurito!\n\nLe foto occupano troppo spazio. Opzioni:\n1. Elimina alcune foto vecchie\n2. Crea un backup e ricomincia\n3. Aggiungi questo oggetto senza foto');
                            return;
                        }
                        throw e;
                    }

                    // Reset form
                    document.getElementById('item-name').value = '';
                    document.getElementById('item-description').value = '';
                    document.getElementById('item-box').value = '';
                    document.getElementById('item-photo').value = '';
                    document.getElementById('photo-preview').style.display = 'none';

                    updateStats();
                    alert('‚úì Oggetto salvato con successo!');
                    showTab('search');
                    displayAllItems();
                } catch (error) {
                    console.error('Errore compressione immagine:', error);
                    alert('Errore nel salvare la foto. Riprova.');
                }
            } else {
                const item = {
                    id: 'item_' + Date.now(),
                    name: name,
                    description: description,
                    boxId: boxId,
                    photo: null,
                    createdAt: new Date().toISOString()
                };

                items.push(item);
                localStorage.setItem('items', JSON.stringify(items));

                // Reset form
                document.getElementById('item-name').value = '';
                document.getElementById('item-description').value = '';
                document.getElementById('item-box').value = '';

                updateStats();
                alert('Oggetto salvato con successo!');
                showTab('search');
                displayAllItems();
            }
        }

        // Mostra scanner QR per selezionare box
        function showQRScanner() {
            // Crea un mini scanner temporaneo
            const modalScanner = document.createElement('div');
            modalScanner.id = 'modal-scanner';
            modalScanner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px;';
            
            const scannerContainer = document.createElement('div');
            scannerContainer.id = 'temp-qr-reader';
            scannerContainer.style.cssText = 'width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Chiudi Scanner';
            closeBtn.className = 'btn btn-secondary';
            closeBtn.style.cssText = 'margin-top: 20px; max-width: 300px;';
            closeBtn.onclick = () => {
                if (tempScannerInstance) {
                    tempScannerInstance.stop().then(() => {
                        document.body.removeChild(modalScanner);
                    });
                } else {
                    document.body.removeChild(modalScanner);
                }
            };
            
            modalScanner.appendChild(scannerContainer);
            modalScanner.appendChild(closeBtn);
            document.body.appendChild(modalScanner);

            let tempScannerInstance = null;
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };

            const tempScanner = new Html5Qrcode("temp-qr-reader");
            tempScannerInstance = tempScanner;

            tempScanner.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    const box = boxes.find(b => b.id === decodedText);
                    if (box) {
                        tempScanner.stop().then(() => {
                            document.body.removeChild(modalScanner);
                            document.getElementById('item-box').value = box.id;
                            alert(`üìä Box "${box.name}" selezionato!`);
                        }).catch(err => {
                            document.body.removeChild(modalScanner);
                            document.getElementById('item-box').value = box.id;
                            alert(`üìä Box "${box.name}" selezionato!`);
                        });
                    } else {
                        // QR code non valido - mostra messaggio ma continua a scansionare
                        const existingError = scannerContainer.querySelector('.qr-error-message');
                        if (!existingError) {
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'qr-error-message';
                            errorMsg.style.cssText = 'position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #EF4444; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
                            errorMsg.textContent = '‚ö†Ô∏è¬†√Ø¬∏¬è QR Code non riconosciuto';
                            scannerContainer.style.position = 'relative';
                            scannerContainer.appendChild(errorMsg);
                            
                            // Rimuovi il messaggio dopo 3 secondi
                            setTimeout(() => {
                                if (errorMsg.parentNode) {
                                    errorMsg.parentNode.removeChild(errorMsg);
                                }
                            }, 3000);
                        }
                    }
                },
                (errorMessage) => {
                    // Ignora errori di scansione continua
                }
            ).catch(err => {
                // Fallback: usa il metodo con scatto foto
                document.body.removeChild(modalScanner);
                
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*';
                tempInput.capture = 'environment';
                
                tempInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.id = 'fallback-qr-reader';
                    fallbackDiv.style.display = 'none';
                    document.body.appendChild(fallbackDiv);

                    const html5QrCode = new Html5Qrcode("fallback-qr-reader");
                    html5QrCode.scanFile(file, true)
                        .then(decodedText => {
                            const box = boxes.find(b => b.id === decodedText);
                            if (box) {
                                document.getElementById('item-box').value = box.id;
                                alert(`Box "${box.name}" selezionato!`);
                            } else {
                                alert('QR Code non riconosciuto.');
                            }
                            document.body.removeChild(fallbackDiv);
                        })
                        .catch(err => {
                            alert('Impossibile leggere il QR code. Riprova.');
                            document.body.removeChild(fallbackDiv);
                        });
                };

                tempInput.click();
            });
        }

        // Avvia scanner QR
        function startScanner() {
            const qrReaderDiv = document.getElementById('qr-reader');
            
            // Prova prima con lo scanner in tempo reale
            if (scanner) {
                scanner.resume();
                return;
            }

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            scanner = new Html5Qrcode("qr-reader");

            scanner.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    // Cerca il box tramite ID o URL
                    let boxToFind = null;
                    
                    // Verifica se √É¬® un URL
                    if (decodedText.includes('?box=')) {
                        try {
                            const url = new URL(decodedText);
                            const boxParam = url.searchParams.get('box');
                            if (boxParam) {
                                const boxInfo = JSON.parse(decodeURIComponent(boxParam));
                                boxToFind = boxes.find(b => b.id === boxInfo.id);
                            }
                        } catch (e) {
                            // Non √É¬® un URL valido, prova come ID semplice
                            boxToFind = boxes.find(b => b.id === decodedText);
                        }
                    } else {
                        // √ÉÀÜ un ID semplice
                        boxToFind = boxes.find(b => b.id === decodedText);
                    }
                    
                    if (boxToFind) {
                        // Ferma lo scanner prima di procedere
                        scanner.stop().then(() => {
                            scanner.clear();
                            scanner = null;
                            // Mostra il box trovato
                            showBoxModal(boxToFind);
                        }).catch(err => {
                            console.error('Errore stop scanner:', err);
                            showBoxModal(boxToFind);
                        });
                    } else {
                        // QR code non valido - mostra messaggio ma continua a scansionare
                        const qrReaderDiv = document.getElementById('qr-reader');
                        const existingError = qrReaderDiv.querySelector('.qr-error-message');
                        if (!existingError) {
                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'qr-error-message';
                            errorMsg.style.cssText = 'position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #EF4444; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
                            errorMsg.textContent = '‚ö†Ô∏è¬†√Ø¬∏¬è QR Code non riconosciuto';
                            qrReaderDiv.style.position = 'relative';
                            qrReaderDiv.appendChild(errorMsg);
                            
                            // Rimuovi il messaggio dopo 3 secondi
                            setTimeout(() => {
                                if (errorMsg.parentNode) {
                                    errorMsg.parentNode.removeChild(errorMsg);
                                }
                            }, 3000);
                        }
                    }
                },
                (errorMessage) => {
                    // Ignora errori di scansione continua
                }
            ).catch((err) => {
                console.error('Errore avvio scanner:', err);
                // Fallback: usa il metodo con scatto foto
                qrReaderDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="margin-bottom: 15px; color: #EF4444;">‚ö†Ô∏è¬†√Ø¬∏¬è Scanner video non disponibile</p>
                        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">Usa il metodo alternativo scattando una foto</p>
                        <input type="file" id="qr-file-input" accept="image/*" capture="environment" style="display: none;" onchange="scanQRFromFile(this)">
                        <label for="qr-file-input" class="btn" style="display: inline-block; cursor: pointer;">
                            ‚úì Scatta Foto QR Code
                        </label>
                        <div id="qr-scan-result" style="margin-top: 20px;"></div>
                    </div>
                `;
            });
        }

        // Scansiona QR da file
        function scanQRFromFile(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const resultDiv = document.getElementById('qr-scan-result');
            resultDiv.innerHTML = '<p style="color: #666;">Scansionando...</p>';

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '300px';
                img.style.borderRadius = '8px';
                img.style.marginBottom = '15px';
                
                resultDiv.innerHTML = '';
                resultDiv.appendChild(img);

                // Prova a decodificare il QR code
                const html5QrCode = new Html5Qrcode("qr-scan-result");
                html5QrCode.scanFile(file, true)
                    .then(decodedText => {
                        // Verifica se √É¬® un box valido
                        const box = boxes.find(b => b.id === decodedText);
                        if (box) {
                            resultDiv.innerHTML += `<p style="color: #10B981; font-weight: 600;">üìä Box trovato: ${box.name}</p>`;
                            
                            setTimeout(() => {
                                showBoxModal(box);
                            }, 1000);
                        } else {
                            resultDiv.innerHTML += '<p style="color: #EF4444;">‚ùå QR Code non riconosciuto</p>';
                        }
                    })
                    .catch(err => {
                        console.error('Errore scansione QR:', err);
                        resultDiv.innerHTML += '<p style="color: #EF4444;">‚ùå Impossibile leggere il QR code. Riprova con un\'immagine pi√É¬π nitida.</p>';
                    });
            };
            reader.readAsDataURL(file);
        }

        // Ferma scanner
        function stopScanner() {
            if (scanner) {
                scanner.stop().then(() => {
                    scanner.clear();
                    scanner = null;
                }).catch((err) => {
                    console.error('Errore stop scanner:', err);
                });
            } else {
                const qrReaderDiv = document.getElementById('qr-reader');
                qrReaderDiv.innerHTML = '';
            }
        }

        // Cerca oggetti
        function searchItems() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results');

            if (!query) {
                displayAllItems();
                return;
            }

            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(query) || 
                (item.description && item.description.toLowerCase().includes(query))
            );

            displayItems(filteredItems, resultsContainer);
        }

        // Visualizza tutti gli oggetti
        function displayAllItems() {
            const resultsContainer = document.getElementById('search-results');
            displayItems(items, resultsContainer);
        }

        // Visualizza oggetti
        function displayItems(itemsToDisplay, container) {
            if (itemsToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>Nessun oggetto trovato</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = itemsToDisplay.map(item => {
                const box = boxes.find(b => b.id === item.boxId);
                const boxName = box ? box.name : 'Box sconosciuto';
                
                return `
                    <div class="item-card" onclick="showItemModal('${item.id}')">
                        ${item.photo ? `<img src="${item.photo}" alt="${item.name}" class="item-photo">` : ''}
                        <h3>${item.name}</h3>
                        <p>${item.description || 'Nessuna descrizione'}</p>
                        <span class="badge">üì¶ ${boxName}</span>
                    </div>
                `;
            }).join('');
        }

        // Visualizza oggetti in un box specifico
        function displayBoxItems(boxId) {
            const boxItems = items.filter(item => item.boxId === boxId);
            const container = document.getElementById('modal-items-list');
            displayItems(boxItems, container);
        }

        // Mostra modal oggetto
        function showItemModal(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            currentItem = item;

            document.getElementById('modal-item-name').textContent = item.name;
            document.getElementById('modal-item-description').textContent = item.description || 'Nessuna descrizione';
            
            const box = boxes.find(b => b.id === item.boxId);
            document.getElementById('modal-item-box').textContent = `üì¶ ${box ? box.name : 'Box sconosciuto'}`;

            const photo = document.getElementById('modal-item-photo');
            if (item.photo) {
                photo.src = item.photo;
                photo.style.display = 'block';
            } else {
                photo.style.display = 'none';
            }

            document.getElementById('item-modal').classList.add('active');
        }

        // Visualizza boxes
        function displayBoxes() {
            const container = document.getElementById('box-list');
            
            if (boxes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <p>Nessun box creato. Crea il tuo primo box!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = boxes.map(box => {
                const boxItems = items.filter(item => item.boxId === box.id);
                return `
                    <div class="box-card" onclick="showBoxModal(${JSON.stringify(box).replace(/"/g, '&quot;')})">
                        <h3>${box.name}</h3>
                        <p>${box.description || 'Nessuna descrizione'}</p>
                        <span class="badge">${boxItems.length} oggetti</span>
                    </div>
                `;
            }).join('');
        }

        // Aggiorna select box
        function updateBoxSelect() {
            const select = document.getElementById('item-box');
            select.innerHTML = '<option value="">Seleziona un box</option>' + 
                boxes.map(box => `<option value="${box.id}">${box.name}</option>`).join('');
        }

        // Aggiorna statistiche
        function updateStats() {
            document.getElementById('box-count').textContent = boxes.length;
            document.getElementById('item-count').textContent = items.length;
        }

        // Elimina box
        function deleteBox() {
            if (!currentBox) return;
            
            if (!confirm(`Sei sicuro di voler eliminare il box "${currentBox.name}"? Verranno eliminati anche tutti gli oggetti al suo interno.`)) {
                return;
            }

            // Elimina box e oggetti
            boxes = boxes.filter(b => b.id !== currentBox.id);
            items = items.filter(i => i.boxId !== currentBox.id);
            
            localStorage.setItem('boxes', JSON.stringify(boxes));
            localStorage.setItem('items', JSON.stringify(items));

            updateStats();
            displayBoxes();
            updateBoxSelect();
            closeModal('box-modal');
            
            alert('Box eliminato con successo!');
        }

        // Apri modal modifica box
        function editBox() {
            if (!currentBox) return;
            
            // Popola i campi del form con i dati attuali
            document.getElementById('edit-box-name').value = currentBox.name;
            document.getElementById('edit-box-description').value = currentBox.description || '';
            
            // Nascondi il modal del box (senza chiuderlo completamente per mantenere currentBox)
            document.getElementById('box-modal').classList.remove('active');
            // Apri quello di modifica
            document.getElementById('edit-box-modal').classList.add('active');
        }

        // Salva modifiche box
        function saveBoxEdit() {
            const newName = document.getElementById('edit-box-name').value.trim();
            const newDescription = document.getElementById('edit-box-description').value.trim();
            
            if (!newName) {
                alert('Inserisci un nome per il box');
                return;
            }
            
            // Trova e aggiorna il box
            const boxIndex = boxes.findIndex(b => b.id === currentBox.id);
            if (boxIndex !== -1) {
                boxes[boxIndex].name = newName;
                boxes[boxIndex].description = newDescription;
                
                localStorage.setItem('boxes', JSON.stringify(boxes));
                
                // Aggiorna currentBox
                currentBox.name = newName;
                currentBox.description = newDescription;
                
                updateStats();
                displayBoxes();
                updateBoxSelect();
                
                // Chiudi modal modifica e riapri quello del box
                document.getElementById('edit-box-modal').classList.remove('active');
                alert('‚úì Box modificato con successo!');
                
                // Riapri il modal del box con i dati aggiornati
                showBoxModal(currentBox);
            }
        }

        // Annulla modifica box
        function cancelBoxEdit() {
            // Chiudi modal modifica e riapri quello del box
            document.getElementById('edit-box-modal').classList.remove('active');
            document.getElementById('box-modal').classList.add('active');
        }

        // Elimina oggetto
        function deleteItem() {
            if (!currentItem) return;
            
            if (!confirm(`Sei sicuro di voler eliminare "${currentItem.name}"?`)) {
                return;
            }

            items = items.filter(i => i.id !== currentItem.id);
            localStorage.setItem('items', JSON.stringify(items));

            updateStats();
            displayAllItems();
            closeModal('item-modal');
            
            alert('Oggetto eliminato con successo!');
        }

        // Chiudi modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            currentBox = null;
            currentItem = null;
        }

        // Chiudi modal cliccando fuori
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // ===== FUNZIONI BACKUP =====

        // Aggiorna informazioni backup
        function updateBackupInfo() {
            document.getElementById('backup-box-count').textContent = boxes.length;
            document.getElementById('backup-item-count').textContent = items.length;
            
            const photosCount = items.filter(item => item.photo).length;
            document.getElementById('backup-photo-count').textContent = photosCount;
            
            // Calcola dimensione approssimativa
            const dataStr = JSON.stringify({boxes, items});
            const sizeBytes = new Blob([dataStr]).size;
            const sizeKB = (sizeBytes / 1024).toFixed(2);
            const sizeMB = (sizeBytes / (1024 * 1024)).toFixed(2);
            
            // Limite tipico del localStorage: 5-10MB (usiamo 5MB come riferimento)
            const maxBytes = 5 * 1024 * 1024;
            const percentUsed = ((sizeBytes / maxBytes) * 100).toFixed(1);
            
            let sizeText = sizeKB + ' KB';
            if (sizeBytes > 1024 * 1024) {
                sizeText = sizeMB + ' MB';
            }
            
            document.getElementById('backup-size').textContent = sizeText + ` (${percentUsed}% usato)`;
            
            // Gestisci avvisi
            const warningDiv = document.getElementById('storage-warning');
            const criticalDiv = document.getElementById('storage-critical');
            
            if (percentUsed >= 80) {
                // Critico: > 80%
                warningDiv.style.display = 'none';
                criticalDiv.style.display = 'block';
                document.getElementById('backup-size').style.color = '#EF4444';
                document.getElementById('backup-size').style.fontWeight = 'bold';
            } else if (percentUsed >= 60) {
                // Avviso: 60-80%
                warningDiv.style.display = 'block';
                criticalDiv.style.display = 'none';
                document.getElementById('backup-size').style.color = '#F59E0B';
                document.getElementById('backup-size').style.fontWeight = 'bold';
            } else {
                // Ok: < 60%
                warningDiv.style.display = 'none';
                criticalDiv.style.display = 'none';
                document.getElementById('backup-size').style.color = '#666';
                document.getElementById('backup-size').style.fontWeight = 'normal';
            }
        }

        // Esporta backup
        function exportBackup() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                boxes: boxes,
                items: items
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `archivio-backup-${dateStr}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            alert('üìä Backup scaricato con successo!');
        }

        // Importa backup
        function importBackup(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validazione base
                    if (!backupData.boxes || !backupData.items) {
                        alert('üì± File di backup non valido');
                        return;
                    }

                    // Conferma prima di sovrascrivere
                    const currentData = boxes.length + items.length;
                    const newData = backupData.boxes.length + backupData.items.length;
                    
                    const confirmMsg = currentData > 0 
                        ? `Hai ${boxes.length} box e ${items.length} oggetti.\n\nIl backup contiene ${backupData.boxes.length} box e ${backupData.items.length} oggetti.\n\n‚ö†Ô∏è¬†√Ø¬∏¬è I dati attuali verranno SOSTITUITI. Continuare?`
                        : `Il backup contiene ${backupData.boxes.length} box e ${backupData.items.length} oggetti.\n\nImportare questi dati?`;
                    
                    if (!confirm(confirmMsg)) {
                        input.value = '';
                        return;
                    }

                    // Importa i dati
                    boxes = backupData.boxes;
                    items = backupData.items;
                    
                    localStorage.setItem('boxes', JSON.stringify(boxes));
                    localStorage.setItem('items', JSON.stringify(items));

                    // Aggiorna interfaccia
                    updateStats();
                    displayBoxes();
                    updateBoxSelect();
                    updateBackupInfo();

                    alert(`üìä Backup importato con successo!\n\n${boxes.length} box e ${items.length} oggetti ripristinati.`);
                    
                    // Torna alla home
                    showTab('home');
                    
                } catch (error) {
                    console.error('Errore importazione backup:', error);
                    alert('üì± Errore durante l\'importazione del backup. Assicurati che il file sia valido.');
                }
                
                input.value = '';
            };

            reader.readAsText(file);
        }

        // Condividi backup
        async function shareBackup() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                boxes: boxes,
                items: items
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const dateStr = new Date().toISOString().split('T')[0];
            const file = new File([blob], `archivio-backup-${dateStr}.json`, { type: 'application/json' });
            
            if (navigator.share && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Backup Archivio Personale',
                        text: `Backup del ${dateStr} - ${boxes.length} box, ${items.length} oggetti`
                    });
                    alert('üìä Backup condiviso con successo!');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Condivisione annullata o fallita', err);
                        // Fallback: scarica il file
                        exportBackup();
                    }
                }
            } else {
                alert('La condivisione non √É¬® supportata su questo dispositivo. Il backup verr√É¬† scaricato.');
                exportBackup();
            }
        }

        // Cancella tutti i dati
        function deleteAllData() {
            if (boxes.length === 0 && items.length === 0) {
                alert('Non ci sono dati da cancellare.');
                return;
            }

            const confirmMsg = `‚ö†Ô∏è¬†√Ø¬∏¬è ATTENZIONE ‚ö†Ô∏è¬†√Ø¬∏¬è\n\nStai per eliminare:\n- ${boxes.length} box\n- ${items.length} oggetti\n- Tutte le foto\n\nQuesta operazione √É¬® IRREVERSIBILE!\n\nDigita "CANCELLA" per confermare:`;
            
            const userInput = prompt(confirmMsg);
            
            if (userInput === 'CANCELLA') {
                // Crea un backup automatico prima di cancellare
                const autoBackup = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    boxes: boxes,
                    items: items
                };
                
                const dataStr = JSON.stringify(autoBackup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `archivio-backup-auto-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                // Cancella i dati
                boxes = [];
                items = [];
                localStorage.removeItem('boxes');
                localStorage.removeItem('items');

                updateStats();
                displayBoxes();
                updateBoxSelect();
                updateBackupInfo();

                alert('üìä Tutti i dati sono stati cancellati.\n\nUn backup automatico √É¬® stato salvato prima della cancellazione.');
                
                showTab('home');
            } else if (userInput !== null) {
                alert('Cancellazione annullata. Devi digitare esattamente "CANCELLA" per confermare.');
            }
        }

        // ===== FUNZIONI PWA INSTALLAZIONE =====

        let installBanner = null;
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        window.addEventListener('appinstalled', () => {
            hideInstallBanner();
            deferredPrompt = null;
        });

        function showInstallBanner() {
            // Controlla se il banner √É¬® gi√É¬† stato mostrato o se l'app √É¬® gi√É¬† installata
            if (localStorage.getItem('installBannerDismissed') === 'true') return;
            if (window.matchMedia('(display-mode: standalone)').matches) return;
            
            installBanner = document.createElement('div');
            installBanner.id = 'install-banner';
            installBanner.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 20px;
                right: 20px;
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 9999;
                animation: slideUp 0.3s ease;
            `;
            
            installBanner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 40px;">üì¶</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 5px 0; color: #333; font-size: 16px;">Installa Archivio</h3>
                        <p style="margin: 0; color: #666; font-size: 13px;">Aggiungi alla schermata home per accesso rapido</p>
                    </div>
                    <button onclick="installApp()" style="background: #4F46E5; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">Installa</button>
                </div>
                <button onclick="dismissInstallBanner()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #999; font-size: 20px; cursor: pointer; padding: 5px;">&times;</button>
            `;
            
            document.body.appendChild(installBanner);
        }

        function hideInstallBanner() {
            if (installBanner && installBanner.parentNode) {
                installBanner.parentNode.removeChild(installBanner);
                installBanner = null;
            }
        }

        function dismissInstallBanner() {
            localStorage.setItem('installBannerDismissed', 'true');
            hideInstallBanner();
        }

        async function installApp() {
            if (!deferredPrompt) {
                alert('Installazione non disponibile. Usa il menu del browser per "Aggiungi alla schermata Home".');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('App installata');
            }
            
            deferredPrompt = null;
            hideInstallBanner();
        }
    </script>
    <style>
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>